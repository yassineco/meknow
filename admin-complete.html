<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Meknow - Gestion Compl√®te</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0B0B0C;
            color: #FFFFFF;
            line-height: 1.6;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background: linear-gradient(135deg, #1A1A1B, #2A2A2B);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #F2C14E;
        }
        .header h1 {
            color: #F2C14E;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .nav {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .nav-btn {
            background: #F2C14E;
            color: #0B0B0C;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .nav-btn:hover, .nav-btn.active {
            background: #E6B641;
            transform: translateY(-2px);
        }
        .section {
            background: #1A1A1B;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #3A3A3B;
            display: none;
        }
        .section.active { display: block; }
        .section h2 {
            color: #F2C14E;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        .grid {
            display: grid;
            gap: 20px;
            margin: 20px 0;
        }
        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .card {
            background: #2A2A2B;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #3A3A3B;
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        .card:hover {
            transform: translateY(-3px);
            border-color: #F2C14E;
        }
        .card h3 {
            color: #F2C14E;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .product-card {
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 15px;
            align-items: start;
        }
        .product-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
        }
        .product-info h4 {
            color: #F2C14E;
            margin-bottom: 8px;
        }
        .product-info p {
            color: #CCCCCC;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status.published { background: #1A4A1A; color: #4CAF50; }
        .status.draft { background: #4A3A1A; color: #FF9800; }
        .status.good { background: #1A4A1A; color: #4CAF50; }
        .status.medium { background: #4A3A1A; color: #FF9800; }
        .status.low { background: #4A1A1A; color: #F44336; }
        .btn {
            background: #F2C14E;
            color: #0B0B0C;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 5px 5px 0;
            transition: all 0.3s ease;
        }
        .btn:hover { background: #E6B641; }
        .btn-danger { background: #F44336; color: white; }
        .btn-danger:hover { background: #D32F2F; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-success:hover { background: #45a049; }
        .input, .textarea, .select {
            width: 100%;
            padding: 12px;
            background: #2A2A2B;
            border: 1px solid #3A3A3B;
            border-radius: 6px;
            color: #FFFFFF;
            margin-bottom: 15px;
        }
        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: #F2C14E;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content {
            background: #1A1A1B;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #F2C14E;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #2A2A2B, #3A3A3B);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #F2C14E;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #F2C14E;
            display: block;
        }
        .stat-label {
            color: #CCCCCC;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .stock-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #3A3A3B;
        }
        .table th {
            background: #2A2A2B;
            color: #F2C14E;
            font-weight: bold;
        }
        .table tr:hover {
            background: #2A2A2B;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Admin Meknow</h1>
            <p>Interface de gestion compl√®te - Produits, Stock, Inventaire</p>
            <div class="nav">
                <button class="nav-btn active" onclick="showSection('dashboard')">üìä Tableau de Bord</button>
                <button class="nav-btn" onclick="showSection('products')">üì¶ Produits</button>
                <button class="nav-btn" onclick="showSection('inventory')">üìã Stock</button>
                <button class="nav-btn" onclick="showSection('settings')">‚öôÔ∏è Param√®tres</button>
            </div>
        </div>

        <!-- Tableau de Bord -->
        <div id="dashboard" class="section active">
            <h2>üìä Tableau de Bord</h2>
            <div class="stats" id="stats-container">
                <!-- Stats will be loaded here -->
            </div>
            <div class="grid grid-2">
                <div class="card">
                    <h3>üî• Produits les plus vendus</h3>
                    <div id="top-products">Loading...</div>
                </div>
                <div class="card">
                    <h3>‚ö†Ô∏è Alertes Stock</h3>
                    <div id="low-stock">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Gestion Produits -->
        <div id="products" class="section">
            <h2>üì¶ Gestion des Produits</h2>
            <button class="btn btn-success" onclick="openProductModal()">+ Nouveau Produit</button>
            <div class="grid grid-2" id="products-container">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Gestion Stock -->
        <div id="inventory" class="section">
            <h2>üìã Gestion du Stock</h2>
            <div class="card">
                <h3>üìä Vue d'ensemble du stock</h3>
                <table class="table" id="inventory-table">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Variant</th>
                            <th>SKU</th>
                            <th>Stock</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Inventory will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Param√®tres -->
        <div id="settings" class="section">
            <h2>‚öôÔ∏è Param√®tres</h2>
            <div class="grid grid-2">
                <div class="card">
                    <h3>üîó URLs API</h3>
                    <p><strong>Frontend:</strong> <a href="http://localhost:5000" target="_blank" style="color: #F2C14E;">http://localhost:5000</a></p>
                    <p><strong>Backend:</strong> <a href="http://localhost:9000" target="_blank" style="color: #F2C14E;">http://localhost:9000</a></p>
                    <p><strong>API Products:</strong> <a href="http://localhost:9000/store/products" target="_blank" style="color: #F2C14E;">/store/products</a></p>
                    <p><strong>API Admin:</strong> <a href="http://localhost:9000/admin/products" target="_blank" style="color: #F2C14E;">/admin/products</a></p>
                </div>
                <div class="card">
                    <h3>üë§ Identifiants Admin</h3>
                    <p><strong>Email:</strong> admin@medusa.com</p>
                    <p><strong>Password:</strong> admin123</p>
                    <button class="btn" onclick="testConnection()">üîç Tester Connexion</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Produit -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <h2>üì¶ Gestion Produit</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <input type="text" id="product-title" placeholder="Titre du produit" class="input" required>
                <input type="text" id="product-handle" placeholder="Handle (URL)" class="input" required>
                <textarea id="product-description" placeholder="Description" class="textarea" rows="4"></textarea>
                <input type="text" id="product-thumbnail" placeholder="URL de l'image" class="input">
                <select id="product-status" class="select">
                    <option value="draft">Brouillon</option>
                    <option value="published">Publi√©</option>
                </select>
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="saveProduct()">üíæ Sauvegarder</button>
                    <button type="button" class="btn" onclick="closeProductModal()">‚ùå Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Stock -->
    <div id="stock-modal" class="modal">
        <div class="modal-content">
            <h2>üìã Mise √† jour Stock</h2>
            <form id="stock-form">
                <input type="hidden" id="variant-id">
                <p><strong>Produit:</strong> <span id="stock-product-name"></span></p>
                <p><strong>Variant:</strong> <span id="stock-variant-name"></span></p>
                <input type="number" id="stock-quantity" placeholder="Nouvelle quantit√©" class="input" required>
                <textarea id="stock-note" placeholder="Note (optionnel)" class="textarea" rows="2"></textarea>
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" onclick="updateStock()">üíæ Mettre √† jour</button>
                    <button type="button" class="btn" onclick="closeStockModal()">‚ùå Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9000';
        let products = [];
        let inventory = [];

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
            
            if (sectionId === 'dashboard') loadDashboard();
            if (sectionId === 'products') loadProducts();
            if (sectionId === 'inventory') loadInventory();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/products`);
                const data = await response.json();
                products = data.products;

                const statsHtml = `
                    <div class="stat-card">
                        <span class="stat-number">${products.length}</span>
                        <div class="stat-label">Produits</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${products.filter(p => p.status === 'published').length}</span>
                        <div class="stat-label">Publi√©s</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${products.reduce((sum, p) => sum + p.variants.length, 0)}</span>
                        <div class="stat-label">Variants</div>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number">${products.reduce((sum, p) => sum + p.variants.reduce((vSum, v) => vSum + (v.inventory_quantity || 0), 0), 0)}</span>
                        <div class="stat-label">Stock Total</div>
                    </div>
                `;
                document.getElementById('stats-container').innerHTML = statsHtml;

                // Top products
                const topProductsHtml = products.slice(0, 3).map(p => `
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <img src="http://localhost:5000${p.thumbnail}" style="width: 40px; height: 40px; border-radius: 6px; margin-right: 10px;">
                        <div>
                            <div style="color: #F2C14E; font-weight: bold;">${p.title}</div>
                            <div style="color: #CCCCCC; font-size: 0.8rem;">${p.variants.length} variants</div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('top-products').innerHTML = topProductsHtml;

                // Low stock alerts
                const lowStockItems = [];
                products.forEach(p => {
                    p.variants.forEach(v => {
                        if (v.inventory_quantity <= 10) {
                            lowStockItems.push({ product: p, variant: v });
                        }
                    });
                });

                const lowStockHtml = lowStockItems.slice(0, 5).map(item => `
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px; padding: 8px; background: #2A2A2B; border-radius: 6px;">
                        <div>
                            <div style="color: #F2C14E; font-size: 0.9rem;">${item.product.title}</div>
                            <div style="color: #CCCCCC; font-size: 0.8rem;">${item.variant.title} - ${item.variant.inventory_quantity} restants</div>
                        </div>
                        <span class="status ${item.variant.inventory_quantity <= 5 ? 'low' : 'medium'}">${item.variant.inventory_quantity <= 5 ? 'Critique' : 'Faible'}</span>
                    </div>
                `).join('');
                document.getElementById('low-stock').innerHTML = lowStockHtml || '<p style="color: #CCCCCC;">Aucune alerte stock</p>';

            } catch (error) {
                console.error('Erreur loading dashboard:', error);
            }
        }

        // Products
        async function loadProducts() {
            try {
                const response = await fetch(`${API_BASE}/admin/products`);
                const data = await response.json();
                products = data.products;

                const productsHtml = products.map(product => `
                    <div class="card">
                        <div class="product-card">
                            <img src="http://localhost:5000${product.thumbnail}" alt="${product.title}" class="product-img">
                            <div class="product-info">
                                <h4>${product.title}</h4>
                                <p>${product.description}</p>
                                <p><strong>Handle:</strong> ${product.handle}</p>
                                <p><strong>Variants:</strong> ${product.variants.length}</p>
                                <span class="status ${product.status}">${product.status}</span>
                            </div>
                            <div>
                                <button class="btn" onclick="editProduct('${product.id}')">‚úèÔ∏è √âditer</button>
                                <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">üóëÔ∏è Supprimer</button>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('products-container').innerHTML = productsHtml;
            } catch (error) {
                console.error('Erreur loading products:', error);
            }
        }

        // Inventory
        async function loadInventory() {
            try {
                const response = await fetch(`${API_BASE}/admin/inventory`);
                const data = await response.json();
                inventory = data.inventory;

                const inventoryHtml = inventory.map(item => `
                    <tr>
                        <td>${item.product_title}</td>
                        <td>${item.variant_title}</td>
                        <td><code>${item.sku}</code></td>
                        <td><strong>${item.inventory_quantity}</strong></td>
                        <td>
                            <span class="stock-indicator" style="background: ${item.status === 'good' ? '#4CAF50' : item.status === 'medium' ? '#FF9800' : '#F44336'};"></span>
                            <span class="status ${item.status}">${item.status === 'good' ? 'Bon' : item.status === 'medium' ? 'Moyen' : 'Faible'}</span>
                        </td>
                        <td>
                            <button class="btn" onclick="openStockModal('${item.variant_id}', '${item.product_title}', '${item.variant_title}', ${item.inventory_quantity})">üìù Modifier</button>
                        </td>
                    </tr>
                `).join('');

                document.querySelector('#inventory-table tbody').innerHTML = inventoryHtml;
            } catch (error) {
                console.error('Erreur loading inventory:', error);
            }
        }

        // Product Modal
        function openProductModal(productId = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            
            if (productId) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-title').value = product.title;
                    document.getElementById('product-handle').value = product.handle;
                    document.getElementById('product-description').value = product.description;
                    document.getElementById('product-thumbnail').value = product.thumbnail;
                    document.getElementById('product-status').value = product.status;
                }
            } else {
                form.reset();
                document.getElementById('product-id').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeProductModal() {
            document.getElementById('product-modal').classList.remove('active');
        }

        async function saveProduct() {
            const productId = document.getElementById('product-id').value;
            const productData = {
                title: document.getElementById('product-title').value,
                handle: document.getElementById('product-handle').value,
                description: document.getElementById('product-description').value,
                thumbnail: document.getElementById('product-thumbnail').value,
                status: document.getElementById('product-status').value
            };

            try {
                const url = productId ? `${API_BASE}/admin/products/${productId}` : `${API_BASE}/admin/products`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    closeProductModal();
                    loadProducts();
                    alert('Produit sauvegard√© avec succ√®s!');
                } else {
                    alert('Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur saving product:', error);
                alert('Erreur de connexion');
            }
        }

        function editProduct(productId) {
            openProductModal(productId);
        }

        async function deleteProduct(productId) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer ce produit?')) {
                try {
                    const response = await fetch(`${API_BASE}/admin/products/${productId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        loadProducts();
                        alert('Produit supprim√© avec succ√®s!');
                    } else {
                        alert('Erreur lors de la suppression');
                    }
                } catch (error) {
                    console.error('Erreur deleting product:', error);
                    alert('Erreur de connexion');
                }
            }
        }

        // Stock Modal
        function openStockModal(variantId, productName, variantName, currentQuantity) {
            document.getElementById('variant-id').value = variantId;
            document.getElementById('stock-product-name').textContent = productName;
            document.getElementById('stock-variant-name').textContent = variantName;
            document.getElementById('stock-quantity').value = currentQuantity;
            document.getElementById('stock-note').value = '';
            document.getElementById('stock-modal').classList.add('active');
        }

        function closeStockModal() {
            document.getElementById('stock-modal').classList.remove('active');
        }

        async function updateStock() {
            const variantId = document.getElementById('variant-id').value;
            const quantity = parseInt(document.getElementById('stock-quantity').value);
            const note = document.getElementById('stock-note').value;

            try {
                const response = await fetch(`${API_BASE}/admin/inventory/${variantId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantity, note })
                });

                if (response.ok) {
                    closeStockModal();
                    loadInventory();
                    loadDashboard(); // Refresh dashboard stats
                    alert('Stock mis √† jour avec succ√®s!');
                } else {
                    alert('Erreur lors de la mise √† jour du stock');
                }
            } catch (error) {
                console.error('Erreur updating stock:', error);
                alert('Erreur de connexion');
            }
        }

        // Test connection
        async function testConnection() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                alert(`‚úÖ Connexion OK: ${data.service}`);
            } catch (error) {
                alert('‚ùå Erreur de connexion au backend');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });
    </script>
</body>
</html>