<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Meknow - Gestion E-commerce Complète</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            overflow-x: hidden;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            background: linear-gradient(45deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            display: block;
            padding: 12px 20px;
            color: #fff;
            text-decoration: none;
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(243, 156, 18, 0.2);
            border-left-color: #f39c12;
        }

        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .content-section.active {
            display: block;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }

        .table {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .table th {
            background: rgba(0, 0, 0, 0.2);
            font-weight: 600;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #f39c12;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
        }

        .close:hover {
            color: #fff;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 600;
        }

        .alert-success {
            background: rgba(46, 204, 113, 0.2);
            border-left: 4px solid #27ae60;
            color: #2ecc71;
        }

        .alert-error {
            background: rgba(231, 76, 60, 0.2);
            border-left: 4px solid #e74c3c;
            color: #e74c3c;
        }

        .alert-warning {
            background: rgba(243, 156, 18, 0.2);
            border-left: 4px solid #f39c12;
            color: #f39c12;
        }

        .image-upload-container {
            border: 2px dashed #f39c12;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(243, 156, 18, 0.1);
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .image-upload-container:hover {
            border-color: #e67e22;
            background: rgba(243, 156, 18, 0.2);
        }

        .image-upload-input {
            display: none;
        }

        #imagePreview {
            display: none;
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .stock-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .stock-low {
            background: #e74c3c;
            color: white;
        }

        .stock-medium {
            background: #f39c12;
            color: white;
        }

        .stock-good {
            background: #27ae60;
            color: white;
        }

        .actions {
            display: flex;
            gap: 5px;
        }

        .debug-console {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            z-index: 3000;
            display: none;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 3000;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Debug -->
    <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    <div id="debugConsole" class="debug-console"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>🔧 Admin Meknow</h1>
            <p>Gestion E-commerce</p>
        </div>
        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" onclick="showSection('dashboard')">📊 Tableau de Bord</a>
            <a href="#" class="nav-item" onclick="showSection('products')">📦 Produits</a>
            <a href="#" class="nav-item" onclick="showSection('inventory')">📋 Stock & Inventaire</a>
            <a href="#" class="nav-item" onclick="showSection('orders')">🛒 Commandes</a>
            <a href="#" class="nav-item" onclick="showSection('customers')">👥 Clients</a>
            <a href="#" class="nav-item" onclick="showSection('analytics')">📈 Analytics</a>
            <a href="#" class="nav-item" onclick="showSection('settings')">⚙️ Paramètres</a>
            <a href="/" class="nav-item">🏠 Retour au Site</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <h1>Gestion E-commerce Meknow</h1>
            <p>Plateforme d'administration complète</p>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section active">
            <h2>📊 Tableau de Bord</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalProducts">-</div>
                    <div>Produits Total</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div>Commandes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">0€</div>
                    <div>Chiffre d'Affaires</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="lowStockCount">-</div>
                    <div>Alertes Stock</div>
                </div>
            </div>

            <div class="alert alert-success">
                ✅ Système opérationnel - Tous les services fonctionnent correctement
            </div>
        </div>

        <!-- Products Section -->
        <div id="products" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>📦 Gestion des Produits</h2>
                <button class="btn btn-primary" onclick="openCreateProductModal()">➕ Nouveau Produit</button>
            </div>

            <table class="table" id="productsTable">
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Nom</th>
                        <th>Prix</th>
                        <th>Stock</th>
                        <th>Statut</th>
                        <th>🎯 Rubriques</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTableBody">
                    <!-- Products will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Inventory Section -->
        <div id="inventory" class="content-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>📋 Gestion du Stock</h2>
                <button class="btn btn-info" onclick="refreshInventory()">🔄 Actualiser</button>
            </div>

            <table class="table" id="inventoryTable">
                <thead>
                    <tr>
                        <th>Produit</th>
                        <th>Variante</th>
                        <th>SKU</th>
                        <th>Stock Actuel</th>
                        <th>Seuil d'Alerte</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Inventory will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Orders Section -->
        <div id="orders" class="content-section">
            <h2>🛒 Gestion des Commandes</h2>
            <div class="alert alert-warning">
                🚧 Section en cours de développement - Intégration système de commandes
            </div>
        </div>

        <!-- Customers Section -->
        <div id="customers" class="content-section">
            <h2>👥 Gestion des Clients</h2>
            <div class="alert alert-warning">
                🚧 Section en cours de développement - Base clients et CRM
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <h2>📈 Analytics & Rapports</h2>
            <div class="alert alert-warning">
                🚧 Section en cours de développement - Analytics et KPIs
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="content-section">
            <h2>⚙️ Paramètres Système</h2>
            
            <div class="form-group">
                <label>Configuration E-commerce</label>
                <div class="alert alert-success">
                    ✅ Upload d'images : Activé<br>
                    ✅ Base de données : PostgreSQL connectée<br>
                    ✅ API Backend : Opérationnelle<br>
                    ✅ SSL/HTTPS : Configuré
                </div>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProductModal()">&times;</span>
            <h2 id="modalTitle">📦 Nouveau Produit</h2>
            
            <form id="productForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="productTitle">Nom du produit *</label>
                        <input type="text" id="productTitle" required>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Prix (€) *</label>
                        <input type="number" id="productPrice" step="0.01" min="0" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="productDescription">Description</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="productCategory">Catégorie</label>
                        <select id="productCategory">
                            <option value="vetements">Vêtements</option>
                            <option value="accessoires">Accessoires</option>
                            <option value="chaussures">Chaussures</option>
                            <option value="bijoux">Bijoux</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productCollection">Collection *</label>
                        <select id="productCollection" required>
                            <option value="coll_capsule" selected>Collection Capsule</option>
                            <option value="coll_nouveautes">Nouveautés</option>
                            <option value="coll_essentiels">Essentiels</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productStatus">Statut</label>
                        <select id="productStatus">
                            <option value="published">Publié</option>
                            <option value="draft">Brouillon</option>
                            <option value="archived">Archivé</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label>Image du produit *</label>
                    <div class="image-upload-container" onclick="triggerFileInput()">
                        <input type="file" id="imageUpload" class="image-upload-input" accept="image/*" onchange="handleImageUpload(this)">
                        
                        <div id="uploadContent">
                            <div style="font-size: 3rem; margin-bottom: 15px;">📷</div>
                            <div style="font-size: 1.2rem; margin-bottom: 10px;">Cliquez pour choisir une image</div>
                            <div style="color: #bdc3c7; font-size: 0.9rem;">JPG, PNG, GIF - Maximum 5MB</div>
                        </div>

                        <img id="imagePreview" alt="Aperçu">
                        <div id="imageInfo"></div>
                    </div>
                </div>

                <!-- 🎯 GESTION DES RUBRIQUES -->
                <h3 style="margin: 30px 0 20px 0; color: #e74c3c;">🎯 Affichage des Rubriques</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label style="display: flex; align-items: center; font-weight: bold;">
                            <input type="checkbox" id="displayCatalog" checked style="margin-right: 10px; transform: scale(1.2);">
                            📦 Afficher dans "Nos Produits" (Catalogue)
                        </label>
                        <small style="color: #bdc3c7; margin-left: 28px;">Section transactionnelle avec prix et bouton achat</small>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; font-weight: bold;">
                            <input type="checkbox" id="displayLookbook" style="margin-right: 10px; transform: scale(1.2);">
                            👗 Afficher dans "Lookbook" (Inspiration)
                        </label>
                        <small style="color: #bdc3c7; margin-left: 28px;">Section inspiration avec ambiance et style</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="lookbookCategory">Catégorie Lookbook</label>
                        <select id="lookbookCategory">
                            <option value="">-- Aucune catégorie --</option>
                            <option value="collection-premium">Collection Premium</option>
                            <option value="savoir-faire-artisanal">Savoir-faire Artisanal</option>
                            <option value="style-contemporain">Style Contemporain</option>
                            <option value="collection-automne">Collection Automne</option>
                        </select>
                        <small style="color: #bdc3c7;">Organisé par thème dans le lookbook</small>
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; font-weight: bold;">
                            <input type="checkbox" id="isFeatured" style="margin-right: 10px; transform: scale(1.2);">
                            ⭐ Produit Vedette
                        </label>
                        <small style="color: #bdc3c7; margin-left: 28px;">Mise en avant sur la page d'accueil</small>
                    </div>
                </div>

                <!-- Stock Management -->
                <h3 style="margin: 30px 0 20px 0; color: #f39c12;">📋 Gestion du Stock</h3>
                <div id="variantsContainer">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Taille S - Stock</label>
                            <input type="number" id="stockS" min="0" value="10">
                        </div>
                        <div class="form-group">
                            <label>Taille M - Stock</label>
                            <input type="number" id="stockM" min="0" value="15">
                        </div>
                        <div class="form-group">
                            <label>Taille L - Stock</label>
                            <input type="number" id="stockL" min="0" value="8">
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button type="submit" class="btn btn-success">💾 Sauvegarder</button>
                    <button type="button" class="btn btn-danger" onclick="closeProductModal()">❌ Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Stock Update Modal -->
    <div id="stockModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeStockModal()">&times;</span>
            <h2>📋 Mise à jour du Stock</h2>
            
            <form id="stockForm">
                <input type="hidden" id="stockVariantId">
                <div class="form-group">
                    <label id="stockProductLabel">Produit</label>
                </div>
                <div class="form-group">
                    <label for="stockQuantity">Nouvelle quantité *</label>
                    <input type="number" id="stockQuantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="stockNote">Note (optionnel)</label>
                    <textarea id="stockNote" rows="2" placeholder="Raison de la modification..."></textarea>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button type="submit" class="btn btn-success">✅ Mettre à jour</button>
                    <button type="button" class="btn btn-danger" onclick="closeStockModal()">❌ Annuler</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Debug console
        let debugEnabled = false;
        let uploadedImageUrl = null;
        let currentEditingProduct = null;
        
        // Vérification d'authentification au chargement
        function checkAuth() {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showNotification('Session expirée. Redirection vers la page de connexion...', 'warning');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
                return false;
            }
            return true;
        }

        // Helper pour obtenir les en-têtes avec authentification
        function getAuthHeaders() {
            const token = localStorage.getItem('adminToken');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Helper pour les requêtes fetch avec authentification
        function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('adminToken');
            if (!token) {
                showNotification('Token d\'authentification manquant', 'error');
                setTimeout(() => window.location.href = '/login', 1500);
                return Promise.reject(new Error('No auth token'));
            }

            const defaultHeaders = {
                'Authorization': `Bearer ${token}`
            };

            // Si c'est un FormData, ne pas ajouter Content-Type
            if (!(options.body instanceof FormData)) {
                defaultHeaders['Content-Type'] = 'application/json';
            }

            const authOptions = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...(options.headers || {})
                }
            };

            return fetch(url, authOptions)
                .then(response => {
                    if (response.status === 401) {
                        showNotification('Session expirée. Redirection...', 'warning');
                        localStorage.removeItem('adminToken');
                        setTimeout(() => window.location.href = '/login', 1500);
                        throw new Error('Authentication failed');
                    }
                    return response;
                });
        }
        
        function debugLog(message) {
            console.log('[DEBUG]', message);
            if (debugEnabled) {
                const console = document.getElementById('debugConsole');
                const time = new Date().toLocaleTimeString();
                console.innerHTML += `[${time}] ${message}\n`;
                console.scrollTop = console.scrollHeight;
            }
        }

        // Vérifier l'authentification au chargement de la page
        window.addEventListener('load', function() {
            if (!checkAuth()) {
                return;
            }
            debugLog('Admin authentifié - Interface prête');
        });

        function showNotification(message, type = 'info') {
            // Créer la notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 10000;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            // Couleurs selon le type
            switch(type) {
                case 'success':
                    notification.style.backgroundColor = '#28a745';
                    break;
                case 'error':
                    notification.style.backgroundColor = '#dc3545';
                    break;
                case 'warning':
                    notification.style.backgroundColor = '#ffc107';
                    notification.style.color = '#000';
                    break;
                default:
                    notification.style.backgroundColor = '#007bff';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animation d'entrée
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Suppression automatique après 4 secondes
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        function toggleDebug() {
            debugEnabled = !debugEnabled;
            const console = document.getElementById('debugConsole');
            console.style.display = debugEnabled ? 'block' : 'none';
            if (debugEnabled) {
                debugLog('Debug console activé');
            }
        }

        // Navigation
        function showSection(sectionId) {
            debugLog(`Switching to section: ${sectionId}`);
            
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked nav item
            event.target.classList.add('active');
            
            // Load section data
            if (sectionId === 'products') {
                loadProducts();
            } else if (sectionId === 'inventory') {
                loadInventory();
            } else if (sectionId === 'dashboard') {
                loadDashboard();
            }
        }

        // Configuration API pour tests
        // Utiliser l'hôte courant au lieu de localhost
        const API_BASE = window.location.origin;
        
        // Dashboard functions
        function loadDashboard() {
            debugLog('Loading dashboard data');
            
            // Utiliser l'API publique temporairement
            fetch(`${API_BASE}/api/products`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalProducts').textContent = data.products.length;
                
                // Count low stock items
                let lowStock = 0;
                data.products.forEach(product => {
                    if (product.variants && Array.isArray(product.variants)) {
                        product.variants.forEach(variant => {
                            if (variant.inventory_quantity <= 5) lowStock++;
                        });
                    }
                });
                document.getElementById('lowStockCount').textContent = lowStock;
                
                debugLog(`Dashboard loaded: ${data.products.length} products, ${lowStock} low stock alerts`);
            })
            .catch(error => {
                debugLog(`Error loading dashboard: ${error.message}`);
                showNotification('Erreur lors du chargement du tableau de bord', 'error');
            });
        }

        // Product functions
        function loadProducts() {
            debugLog('Loading products for management');
            
            // Utiliser l'API publique temporairement
            fetch(`${API_BASE}/api/products`)
            .then(response => {
                debugLog(`Products API response status: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                debugLog(`Received products data:`, data);
                const tbody = document.getElementById('productsTableBody');
                
                if (!tbody) {
                    debugLog('ERROR: productsTableBody element not found');
                    return;
                }
                
                tbody.innerHTML = '';
                
                if (!data || !data.products) {
                    debugLog('ERROR: No products data received');
                    return;
                }
                
                debugLog(`Processing ${data.products.length} products`);
                
                data.products.forEach((product, index) => {
                    debugLog(`Processing product ${index + 1}: ${product.title}`);
                    
                    // Handle different variant structures
                    let price = '0.00';
                    let totalStock = 0;
                    
                    if (product.price) {
                        // Simple price structure
                        price = product.price.toFixed(2);
                    } else if (Array.isArray(product.variants) && product.variants.length > 0) {
                        // Array of variants with prices
                        try {
                            price = (product.variants[0].prices[0].amount / 100).toFixed(2);
                            totalStock = product.variants.reduce((sum, v) => sum + v.inventory_quantity, 0);
                        } catch (e) {
                            debugLog(`Error processing variant prices for ${product.title}:`, e);
                        }
                    } else if (typeof product.variants === 'object') {
                        // Object with variant stocks
                        totalStock = Object.values(product.variants).reduce((sum, stock) => sum + stock, 0);
                        price = product.price ? product.price.toFixed(2) : '0.00';
                    }
                    
                    let stockClass = 'stock-good';
                    if (totalStock <= 5) stockClass = 'stock-low';
                    else if (totalStock <= 15) stockClass = 'stock-medium';
                    
                    // 🎯 Génération des badges de rubriques
                    let rubriquesBadges = '';
                    if (product.display_sections) {
                        if (product.display_sections.includes('catalog')) {
                            rubriquesBadges += '<span style="background: #27ae60; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">📦 Catalogue</span>';
                        }
                        if (product.display_sections.includes('lookbook')) {
                            rubriquesBadges += '<span style="background: #e74c3c; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-right: 5px;">👗 Lookbook</span>';
                        }
                    } else {
                        rubriquesBadges = '<span style="background: #95a5a6; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em;">❓ Non défini</span>';
                    }
                    
                    if (product.is_featured) {
                        rubriquesBadges += '<span style="background: #f39c12; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 5px;">⭐ Vedette</span>';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${product.thumbnail}" alt="${product.title}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                        <td>${product.title}</td>
                        <td>${price}€</td>
                        <td><span class="stock-indicator ${stockClass}">${totalStock}</span></td>
                        <td>${product.status === 'published' ? '✅ Publié' : '⏸️ Brouillon'}</td>
                        <td>${rubriquesBadges}</td>
                        <td class="actions">
                            <button class="btn btn-info" onclick="editProduct('${product.id}')">✏️</button>
                            <button class="btn btn-danger" onclick="deleteProduct('${product.id}')">🗑️</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                debugLog(`Successfully loaded ${data.products.length} products for management`);
                showNotification(`${data.products.length} produits chargés avec succès`, 'success');
            })
            .catch(error => {
                debugLog(`Error loading products: ${error.message}`);
                console.error('Full error:', error);
                showNotification('Erreur lors du chargement des produits: ' + error.message, 'error');
            });
        }

        // Inventory functions
        function loadInventory() {
            debugLog('Loading inventory data');
            
            // Utiliser l'API publique temporairement
            fetch(`${API_BASE}/api/products`)
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('inventoryTableBody');
                tbody.innerHTML = '';
                
                data.products.forEach(product => {
                    product.variants.forEach(variant => {
                        let stockClass = 'stock-good';
                        if (variant.inventory_quantity <= 5) stockClass = 'stock-low';
                        else if (variant.inventory_quantity <= 15) stockClass = 'stock-medium';
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.title}</td>
                            <td>${variant.title}</td>
                            <td>${variant.sku}</td>
                            <td><span class="stock-indicator ${stockClass}">${variant.inventory_quantity}</span></td>
                            <td>5</td>
                            <td>
                                <button class="btn btn-primary" onclick="openStockModal('${variant.id}', '${product.title}', '${variant.title}', ${variant.inventory_quantity})">📝 Modifier</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                });
                
                debugLog('Inventory data loaded');
            })
            .catch(error => {
                debugLog(`Error loading inventory: ${error.message}`);
            });
        }

        function refreshInventory() {
            debugLog('Refreshing inventory');
            loadInventory();
        }

        // Modal functions
        function openCreateProductModal() {
            debugLog('Opening create product modal');
            document.getElementById('modalTitle').textContent = '📦 Nouveau Produit';
            currentEditingProduct = null;
            resetProductForm();
            document.getElementById('productModal').style.display = 'block';
        }

        function editProduct(productId) {
            debugLog(`Opening edit modal for product: ${productId}`);
            
            // Récupérer les données du produit
            fetch(`${API_BASE}/api/products/${productId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const product = data.product;
                        currentEditingProduct = productId;
                        
                        // Remplir le formulaire avec les données existantes
                        document.getElementById('productTitle').value = product.title;
                        document.getElementById('productDescription').value = product.description || '';
                        document.getElementById('productPrice').value = product.price || 0;
                        
                        // Remplir les stocks par taille
                        if (product.variants.length >= 1) document.getElementById('stockS').value = product.variants[0].inventory_quantity;
                        if (product.variants.length >= 2) document.getElementById('stockM').value = product.variants[1].inventory_quantity;
                        if (product.variants.length >= 3) document.getElementById('stockL').value = product.variants[2].inventory_quantity;
                        
                        // Afficher l'image actuelle si elle existe
                        if (product.thumbnail) {
                            const preview = document.getElementById('imagePreview');
                            preview.src = product.thumbnail;
                            preview.style.display = 'block';
                        }
                        
                        // Changer le titre du modal
                        document.getElementById('modalTitle').textContent = '✏️ Modifier Produit';
                        document.getElementById('productModal').style.display = 'block';
                    }
                })
                .catch(error => {
                    debugLog('Erreur lors du chargement du produit:', error);
                    showNotification('Erreur lors du chargement du produit', 'error');
                });
        }

        function deleteProduct(productId) {
            debugLog(`Delete request for product: ${productId}`);
            if (confirm('Êtes-vous sûr de vouloir supprimer ce produit ?')) {
                fetch(`${API_BASE}/api/products/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message, 'success');
                        loadProducts(); // Recharger la liste
                        loadDashboard(); // Mettre à jour les stats
                    } else {
                        showNotification('Erreur lors de la suppression: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    debugLog('Erreur lors de la suppression:', error);
                    showNotification('Erreur lors de la suppression', 'error');
                });
            }
        }

        function closeProductModal() {
            debugLog('Closing product modal');
            document.getElementById('productModal').style.display = 'none';
            resetProductForm();
        }

        function resetProductForm() {
            debugLog('Resetting product form');
            document.getElementById('productForm').reset();
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('uploadContent').style.display = 'block';
            document.getElementById('imageInfo').innerHTML = '';
            uploadedImageUrl = null;
            currentEditingProduct = null;
        }

        // Stock modal functions
        function openStockModal(variantId, productTitle, variantTitle, currentStock) {
            debugLog(`Opening stock modal for variant: ${variantId}`);
            document.getElementById('stockVariantId').value = variantId;
            document.getElementById('stockProductLabel').textContent = `${productTitle} - ${variantTitle}`;
            document.getElementById('stockQuantity').value = currentStock;
            document.getElementById('stockNote').value = '';
            document.getElementById('stockModal').style.display = 'block';
        }

        function closeStockModal() {
            debugLog('Closing stock modal');
            document.getElementById('stockModal').style.display = 'none';
        }

        // Image upload
        function triggerFileInput() {
            debugLog('Trigger file input clicked');
            document.getElementById('imageUpload').click();
        }

        function handleImageUpload(input) {
            debugLog('handleImageUpload called');
            const file = input.files[0];
            if (!file) {
                debugLog('No file selected');
                return;
            }

            debugLog(`File selected: ${file.name} (${file.size} bytes, ${file.type})`);

            // Validation
            if (!file.type.startsWith('image/')) {
                alert('Veuillez sélectionner un fichier image valide (JPG, PNG, GIF)');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('L\'image est trop volumineuse. Taille maximum : 5MB');
                return;
            }

            // Preview image
            const reader = new FileReader();
            reader.onload = function(e) {
                debugLog('Image preview loaded');
                const preview = document.getElementById('imagePreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('uploadContent').style.display = 'none';
                
                document.getElementById('imageInfo').innerHTML = `
                    📁 ${file.name}<br>
                    📏 ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    🖼️ ${file.type}
                `;
            };
            reader.readAsDataURL(file);

            // Upload to server
            const formData = new FormData();
            formData.append('image', file);

            debugLog('Sending upload request to /api/upload');

            authenticatedFetch(`${API_BASE}/api/upload`, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                debugLog(`Upload response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                debugLog(`Upload response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    uploadedImageUrl = data.url;
                    debugLog(`Image uploaded successfully: ${data.url}`);
                } else {
                    alert(`❌ Erreur d'upload: ${data.error}`);
                    debugLog(`Upload error: ${data.error}`);
                }
            })
            .catch(error => {
                debugLog(`Upload error: ${error.message}`);
                alert(`❌ Erreur de connexion: ${error.message}`);
                console.error('Upload error:', error);
            });
        }

        // Form submissions
        document.getElementById('productForm').addEventListener('submit', function(e) {
            e.preventDefault();
            debugLog('Product form submission started');
            
            const isEditing = currentEditingProduct !== null;
            
            // Pour la modification, l'image n'est pas obligatoire (on peut garder l'ancienne)
            if (!isEditing && !uploadedImageUrl) {
                alert('❌ Veuillez d\'abord uploader une image');
                return;
            }

            // 🎯 Récupération des données de rubriques
            const displaySections = [];
            if (document.getElementById('displayCatalog').checked) {
                displaySections.push('catalog');
            }
            if (document.getElementById('displayLookbook').checked) {
                displaySections.push('lookbook');
            }

            const productData = {
                title: document.getElementById('productTitle').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                status: document.getElementById('productStatus').value,
                collection_id: document.getElementById('productCollection').value,
                // 🎯 NOUVEAUX CHAMPS RUBRIQUES
                display_sections: displaySections,
                lookbook_category: document.getElementById('lookbookCategory').value || null,
                is_featured: document.getElementById('isFeatured').checked,
                variants: {
                    S: parseInt(document.getElementById('stockS').value),
                    M: parseInt(document.getElementById('stockM').value),
                    L: parseInt(document.getElementById('stockL').value)
                }
            };

            // Ajouter l'image seulement si une nouvelle a été uploadée
            if (uploadedImageUrl) {
                productData.imageUrl = uploadedImageUrl;
            }

            debugLog(`Sending product data: ${JSON.stringify(productData)}`);

            const url = isEditing ? `${API_BASE}/api/products/${currentEditingProduct}` : `${API_BASE}/api/products`;
            const method = isEditing ? 'PUT' : 'POST';
            const action = isEditing ? 'modifié' : 'créé';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(productData)
            })
            .then(response => {
                debugLog(`Product ${action} response status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                debugLog(`Product ${action} response: ${JSON.stringify(data)}`);
                
                if (data.success) {
                    showNotification(`✅ Produit "${productData.title}" ${action} avec succès!`, 'success');
                    closeProductModal();
                    loadProducts();
                    loadDashboard();
                } else {
                    showNotification(`❌ Erreur lors de la ${isEditing ? 'modification' : 'création'}: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                debugLog(`Product ${action} error: ${error.message}`);
                showNotification(`❌ Erreur de connexion: ${error.message}`, 'error');
            });
        });

        document.getElementById('stockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            debugLog('Stock form submission started');
            
            const variantId = document.getElementById('stockVariantId').value;
            const quantity = parseInt(document.getElementById('stockQuantity').value);
            const note = document.getElementById('stockNote').value;
            
            debugLog(`Updating stock for variant ${variantId} to ${quantity}`);
            
            // Here you would call the stock update API
            alert(`Stock mis à jour pour la variante ${variantId}: ${quantity} unités`);
            closeStockModal();
            loadInventory();
            loadDashboard();
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Admin interface loaded, initializing...');
            if (checkAuth()) {
                loadDashboard();
                loadProducts();
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            const productModal = document.getElementById('productModal');
            const stockModal = document.getElementById('stockModal');
            
            if (event.target == productModal) {
                closeProductModal();
            } else if (event.target == stockModal) {
                closeStockModal();
            }
        }
    </script>
</body>
</html>